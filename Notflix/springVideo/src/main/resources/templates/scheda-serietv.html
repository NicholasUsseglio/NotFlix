<!DOCTYPE html>
<html lang="it"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{fragments :: head('Scheda Serie TV')}"></head>

<link rel="stylesheet" th:href="@{/css/scheda-film.css}" />

<body>

<header th:replace="~{fragments :: header('home')}"></header>

<main class="page-wrapper" style="padding:48px 24px;max-width:1200px;margin:0 auto;">

    <div th:if="${serietv != null}" style="display:flex;gap:40px;align-items:flex-start;flex-wrap:wrap;">

        <!-- Poster -->
        <aside style="flex:0 0 360px;max-width:360px;">
            <div style="background:rgba(255,255,255,0.03);padding:16px;border-radius:6px;">
                <div class="poster-placeholder"
                     style="height:540px;display:flex;align-items:center;justify-content:center;overflow:hidden;">
                    <img th:if="${serietv.id != null}"
                         th:src="@{/img/posters/{id}.jpg(id=${serietv.id})}"
                         alt="Locandina serie TV"
                         style="width:100%;height:100%;object-fit:cover;display:block;">
                    <div th:if="${serietv.id == null}" style="color:var(--muted);">Nessuna immagine</div>
                </div>

                <a th:href="@{'/player/' + ${serietv.id}}" 
                   class="nav-pill" 
                   style="display:flex;align-items:center;justify-content:center;
                          padding:12px 16px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    Guarda
                </a>
            </div>
        </aside>

        <!-- Contenuto principale -->
        <section style="flex:1 1 560px;min-width:280px;color:var(--text);">
            <header style="margin-bottom:22px;">
                <h1 style="font-family: Georgia, 'Times New Roman', serif;
                           font-size:38px;margin:0 0 8px;color:#fff;letter-spacing:0.6px;"
                    th:text="${serietv.titolo}">Titolo</h1>

                <!-- Dati generali -->
                <div style="color:var(--muted);font-size:0.95rem;">
                    <span th:text="${registaNome}">Regista</span>
                    <span>·</span>
                    <span th:text="${#dates.format(serietv.annoUscita,'yyyy')}">2024</span>
                    <span>·</span>
                    <span th:text="${serietv.genere}">Genere</span>
                    <span th:if="${serietv.numeroStagioni != null}"> · 
                        <span th:text="${serietv.numeroStagioni + ' stagioni'}">1 stagione</span>
                    </span>
                    <span th:if="${serietv.numeroEpisodi != null}"> · 
                        <span th:text="${serietv.numeroEpisodi + ' episodi'}">8 episodi</span>
                    </span>
                </div>
            </header>

            <!-- Trama -->
            <div style="margin-bottom:18px;color:var(--muted);line-height:1.6;">
                <strong>Trama:</strong>
                <span th:text="${serietv.trama != null ? serietv.trama : 'Trama non disponibile.'}">—</span>
            </div>

            <!-- Preferiti e Watchlist -->
            <div style="display:flex;gap:12px;align-items:center;margin-bottom:22px;">
                <div sec:authorize="isAuthenticated()" style="display:flex;gap:8px;">
                    <!-- Preferiti -->
                    <form th:action="@{'/serietv/' + ${serietv.id} + '/preferito'}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button class="nav-pill" type="submit" style="padding:10px 14px;"> 
                            <span th:if="${isPreferito}">&#9733; Nei preferiti</span>
                            <span th:if="${!isPreferito}">&#128970; Aggiungi ai preferiti</span>
                        </button>
                    </form>

                    <!-- Watchlist -->
                    <form th:action="@{'/serietv/' + ${serietv.id} + '/watchlist'}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button class="nav-pill" type="submit" style="padding:10px 14px;"> 
                            <span th:if="${isWatchlist}">&#9733; In watchlist</span>
                            <span th:if="${!isWatchlist}">&#10084; Aggiungi alla watchlist</span>
                        </button>
                    </form>
                </div>

                <div sec:authorize="isAnonymous()">
                    <a th:href="@{/auth/login}" class="nav-pill"
                       style="padding:10px 14px;">Accedi per la watchlist / preferiti</a>
                </div>

                <div style="margin-left:auto;color:var(--muted);font-size:0.95rem;">
                    <strong th:text="${mediaVoto != null ? #numbers.formatDecimal(mediaVoto,1,1) : '—'}">4.2</strong>/5
                    · <span th:text="${numRecensioni}">0</span> voti
                </div>
            </div>

            <!-- Form recensione -->
            <div style="background:rgba(255,255,255,0.02);padding:14px;border-radius:6px;margin-top:18px;">
                <div sec:authorize="isAuthenticated()" style="margin-bottom:12px;">
                    <form th:action="@{'/serietv/' + ${serietv.id} + '/valuta'}"
                          method="post"
                          style="display:flex;flex-direction:column;gap:8px;align-items:stretch;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="voto" id="voto-input" th:value="${mioVoto}">

                        <div id="star-rating" class="star-rating" style="margin-bottom:8px;">
                            <div class="stars-back">★★★★★</div>
                            <div class="stars-front" aria-hidden="true"></div>
                        </div>

                        <textarea name="recensione" rows="4" th:text="${miaRecensione}"
                                  placeholder="Lascia una recensione..."
                                  style="width:100%;padding:8px;border-radius:4px;
                                         background:transparent;border:1px solid rgba(255,255,255,0.06);
                                         color:var(--text);"></textarea>

                        <div style="display:flex;justify-content:flex-end;">
                            <button type="submit" class="nav-pill">Invia</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Cast -->
            <div id="cast-section" style="margin-top:22px;color:var(--muted);">
                <div style="font-weight:700;margin-bottom:8px;">Cast</div>
                <div th:if="${cast != null}" style="display:flex;flex-wrap:wrap;gap:8px;">
                    <a th:each="a : ${cast}"
                       th:href="@{'/attore/' + ${a.id}}"
                       th:text="${a.nome + ' ' + a.cognome}"
                       style="background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:4px;
                              color:#e0e0e0;text-decoration:none;">
                    </a>
                </div>
            </div>

            <!-- Elenco recensioni -->
            <div id="reviews-list" style="margin-top:18px;">
                <h3 style="margin-bottom:10px;color:#fff;">Recensioni</h3>
                <div th:if="${#lists.isEmpty(recensioni)}" style="color:var(--muted);">
                    Nessuna recensione
                </div>
                <div th:each="r : ${recensioni}"
                     style="border-top:1px solid rgba(255,255,255,0.03);padding:12px 0;margin-top:10px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="font-weight:700;color:#fff;"
                             th:text="${r.utente != null ? r.utente.username : 'Anonimo'}">utente</div>
                        <div style="color:var(--muted);" th:text="${r.voto + '/5'}">4/5</div>
                    </div>
                    <div style="color:var(--muted);margin-top:8px;"
                         th:text="${r.recensione}">Testo recensione</div>
                </div>
            </div>

            <!-- Elenco Serie TV correlate -->
            <div id="correlati-genere-section" style="margin-top:30px;">
                <h3 style="margin-bottom:10px;color:#fff;">Serie TV Correlate</h3>
                
                <div th:if="${serieTvCorrelatePerGenere == null or #lists.isEmpty(serieTvCorrelatePerGenere)}" style="color:var(--muted);">
                    Nessuna serie TV correlata trovata.
                </div>
                
                <div th:if="${serieTvCorrelatePerGenere != null and !#lists.isEmpty(serieTvCorrelatePerGenere)}">
                    <ul style="list-style:none;padding:0;">
                        <li th:each="tc, iterStat : ${serieTvCorrelatePerGenere}" 
                            th:if="${iterStat.index < 3}"
                            style="border-bottom:1px solid rgba(255,255,255,0.03);padding:8px 0;">
                            
                            <a th:href="@{'/serietv/' + ${tc.id}}"
                               style="color:#e0e0e0;text-decoration:none;display:block;">
                                <span th:text="${tc.titolo}">Titolo Correlato</span>
                                <span style="color:var(--muted);font-size:0.9rem;">
                                    ( <span th:text="${#dates.format(tc.annoUscita,'yyyy')}">2024</span> )
                                </span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            </section>
    </div>

    <!-- Serie TV non trovata -->
    <div th:if="${serietv == null}" style="padding:48px;text-align:center;color:var(--muted);">
        <h2>Serie TV non trovata</h2>
        <p>Impossibile caricare i dettagli della serie TV.
           Torna alla <a th:href="@{/}">home</a>.</p>
    </div>

</main>

<footer th:replace="~{fragments :: footer}"></footer>

<!-- Rating e menù -->
<script th:src="@{/js/rating.js}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Catalogo
    const catalogoBtn = document.getElementById('catalogoBtn');
    const catalogoMenu = document.getElementById('catalogoMenu');

    if (catalogoBtn && catalogoMenu) {
        catalogoBtn.addEventListener('click', function (event) {
            event.stopPropagation();
            const isVisible = catalogoMenu.style.display === 'block';
            catalogoMenu.style.display = isVisible ? 'none' : 'block';
        });

        document.addEventListener('click', function (event) {
            if (!catalogoBtn.contains(event.target)) {
                catalogoMenu.style.display = 'none';
            }
        });
    }

    // Utente
    const utenteBtn = document.getElementById('utenteBtn');
    const utenteMenu = document.getElementById('utenteMenu');

    if (utenteBtn && utenteMenu) {
        utenteBtn.addEventListener('click', function (event) {
            event.stopPropagation();
            const isVisible = utenteMenu.style.display === 'block';
            utenteMenu.style.display = isVisible ? 'none' : 'block';
        });

        document.addEventListener('click', function (event) {
            if (!utenteBtn.contains(event.target)) {
                utenteMenu.style.display = 'none';
            }
        });
    }
});

const logoutTrigger = document.getElementById('logoutTrigger');
const logoutForm = document.getElementById('logoutForm');

if (logoutTrigger && logoutForm) {
    logoutTrigger.addEventListener('click', function () {
        logoutForm.submit();
    });
}
</script>
</body>
</html>
