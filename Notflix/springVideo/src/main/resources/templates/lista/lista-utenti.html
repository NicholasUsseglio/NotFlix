<!DOCTYPE html>
<html lang="it"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="fragments :: head('Area Admin - Lista Utenti')">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<body>
<link rel="stylesheet" th:href="@{/css/style-utenti.css}" />

<header  th:replace="fragmentsAreaUtente :: headerAreaUtente(paginaAttiva)"></header>

<main class="main container mx-auto p-6">

    <!-- üîç Barra di ricerca -->
    <section class="nav" style="justify-content: space-between">
        <a href="/auth/admin" class="nav-pill">‚Üê Indietro</a>
        <h1 class="text-2xl font-bold text-white" th:text="'Lista Utenti'">Lista Utenti</h1>

       <form th:action="@{/auth/admin/lista-utenti}" method="get"
            style="display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.08);
                    border-radius:999px;padding:4px 10px; max-width: 400px;">
            <input type="text" name="q" placeholder="Cerca utente"
                style="background:transparent;border:none;color:var(--white,#fff);
                        font-size:0.9rem;line-height:1;min-width:140px;outline:none;" />
            <button type="submit" style="background:transparent;border:none;color:var(--white,#fff);
                                        font-size:0.9rem;line-height:1;cursor:pointer;">
                üîç
            </button>
        </form>
    </section>

    <!-- üìã Tabella utenti -->
   <section class="user-table-container" style="    margin: 10px auto;">
        <table class="user-table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Cognome</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Ruolo</th>
                    <th>Azioni</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="u : ${utenti}">
                    <td th:text="${u.nome}">Mario</td>
                    <td th:text="${u.cognome}">Rossi</td>
                    <td th:text="${u.username}">mario.rossi</td>
                    <td th:text="${u.email}">mario@example.com</td>
                    <td th:text="${u.role}">ADMIN</td>
                    <td  style="display: flex;">
                        <!-- Pulsante modifica -->
                        <button type="button"
                                class="btn-edit"
                                th:attr="data-id=${u.id}"
                                onclick="editUser(this)">
                             Modifica
                        </button>

                        <!-- Pulsante elimina -->
                        <button type="button"
                                class="btn-delete"
                                th:attr="data-id=${u.id}"
                                onclick="deleteUser(this)">
                            Elimina
                        </button>
                    </td>
                </tr>
                <tr th:if="${utenti == null or utenti.empty}">
                    <td colspan="4" class="text-center">Nessun utente trovato.</td>
                </tr>
            </tbody>
        </table>
        <input type="hidden" id="userId" />
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

    </section>

</main>

<footer th:replace="fragments :: footer"></footer>



<!-- üß© Modale Modifica Utente -->
<div id="userModal" class="modal" style="display:none;">
    

    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Modifica Utente</h2>

        <form id="editUserForm">
            <input type="hidden" name="id" id="userId">

            <label>Nome:</label>
            <input type="text" name="nome" id="userNome">

            <label>Cognome:</label>
            <input type="text" name="cognome" id="userCognome">

            <label>Username:</label>
            <input type="text" name="username" id="userUsername">

            <label>Email:</label>
            <input type="email" name="email" id="userEmail">

            <label>Nazionalit√†:</label>
            <input type="text" name="nazionalita" id="userNazionalita">

            <label>Data di nascita:</label>
            <input type="date" name="dataNascita" id="userDataNascita">

            <label >Ruolo:</label>
                <select name="ruolo" style="margin-bottom: 15px;" class="option">
                    <option value="USER" >USER</option>
                    <option value="ADMIN">ADMIN</option>
                </select>
            <div class="modal-actions">
                <button type="submit" class="btn-delete">üíæ Salva</button>
                <button type="button" onclick="closeModal()" class="btn-edit">‚úñ Annulla</button>
            </div>
        </form>
    </div>
</div>
<script>
/* --- Mostra e popola il modale con i dati utente --- */
function editUser(button) {
    const userId = button.getAttribute("data-id");

    // Recupera i dati dell‚Äôutente dal backend
    fetch(`/auth/admin/getUser?id=${userId}`)
        .then(response => {
            if (!response.ok) throw new Error("Errore nel caricamento dei dati utente");
            return response.json();
        })
        .then(user => {
            // Popola i campi del form con i dati reali
            document.getElementById("userId").value = user.id || "";
            document.getElementById("userNome").value = user.nome || "";
            document.getElementById("userCognome").value = user.cognome || "";
            document.getElementById("userUsername").value = user.username || "";
            document.getElementById("userEmail").value = user.email || "";
            document.getElementById("userNazionalita").value = user.nazionalita || "";
            document.getElementById("userDataNascita").value = user.dataNascita || "";

            // Se il ruolo esiste nel JSON, imposta il valore nel select
            const roleSelect = document.querySelector("select[name='ruolo']");
            if (roleSelect && user.ruolo) {
                roleSelect.value = user.ruolo;
            }

            // Mostra il modale
            document.getElementById("userModal").style.display = "block";
        })
        .catch(err => {
            console.error(err);
            alert("Impossibile caricare i dati dell‚Äôutente.");
        });
}

/* --- Chiude il modale --- */
function closeModal() {
    const modal = document.getElementById("userModal");
    if (modal) modal.style.display = "none";
}

/* --- Gestione salvataggio utente --- */
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("editUserForm");
    if (!form) return;

    form.addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        // Prende il token CSRF in sicurezza
        const csrfMeta = document.querySelector('meta[name="_csrf"]');
        const csrfToken = csrfMeta ? csrfMeta.getAttribute("content") : "";

        fetch("/auth/admin/aggiornaUtenteAdmin", {
            method: "PUT", 
            body: new URLSearchParams(formData),
            headers: {
                "X-CSRF-TOKEN": csrfToken
            }
        })
            .then(response => {
                if (response.ok) {
                    alert("Utente aggiornato con successo!");
                    closeModal(); // Chiude il modale dopo il salvataggio
                    window.location.reload(); // Ricarica la lista utenti
                } else {
                    alert("Errore durante l‚Äôaggiornamento dell‚Äôutente.");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Errore di rete durante l‚Äôaggiornamento.");
            });
    });
});

/* --- Elimina utente --- */
function deleteUser(button) {
    const userId = button.getAttribute("data-id");
    if (!userId) {
        alert("ID utente non valido!");
        return;
    }

    // CSRF
    const csrfToken = document.querySelector('input[name="_csrf"]').value;

    if (!confirm("Sei sicuro di voler eliminare questo utente?")) return;

    fetch(`/auth/admin/delete?id=${userId}`, {
        method: "DELETE",
        headers: {
            "X-CSRF-TOKEN": csrfToken
        },
        redirect: "follow" // <--- permette di seguire il redirect 302
    })
    .then(response => {
        // Anche se √® un 302, consideralo successo
        if (response.status === 200 || response.status === 302 || response.status === 204) {
            alert("Utente eliminato!");
            window.location.reload();
        } else {
            throw new Error("Errore durante l'eliminazione");
        }
    })
    .catch(err => {
        console.error(err);
        alert("Impossibile eliminare l'utente.");
    });
}
/* --- Chiude cliccando fuori dal modale --- */
window.addEventListener("click", function (e) {
    const modal = document.getElementById("userModal");
    if (e.target === modal) {
        closeModal();
    }
});
</script>

<script th:src="@{/js/main.js}"> </script>

</body>
</html>